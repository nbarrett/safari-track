#!/usr/bin/env bash
set -euo pipefail

REMOTE="${1:-origin}"

# Load nvm
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Read refs from stdin: local_ref local_sha remote_ref remote_sha
should_run=false
while read -r local_ref local_sha remote_ref remote_sha; do
  case "$remote_ref" in
    *refs/heads/main|*refs/heads/pre-main)
      should_run=true
      ;;
  esac
done

if [ "$should_run" = true ]; then
  echo "Pre-push: running type check..."
  pnpm exec tsc --noEmit

  if pnpm run --silent test --passWithNoTests 2>/dev/null; then
    echo "Tests passed."
  else
    echo "Pre-push: no test script configured, skipping tests."
  fi

  echo "Pre-push: checking for version bump..."
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
  BEFORE_SHA=$(git rev-parse HEAD)
  node "$SCRIPT_DIR/../scripts/auto-changelog.mjs" || true
  AFTER_SHA=$(git rev-parse HEAD)

  if [ "$BEFORE_SHA" != "$AFTER_SHA" ]; then
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    echo "Pre-push: pushing version bump..."
    git push --no-verify "$REMOTE" "$BRANCH"
  fi

  echo "Pre-push checks passed. Proceeding with push."
else
  echo "Pre-push: target branch is not main or pre-main. Skipping checks."
fi

exit 0
