#!/bin/bash

set -e

REMOTE="${1:-origin}"
ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

source "${ROOT_DIR}/node_modules/@annix/claude-swarm/timer.sh"

should_run=false
while read -r local_ref local_sha remote_ref remote_sha; do
  case "$remote_ref" in
    *refs/heads/main|*refs/heads/pre-main)
      should_run=true
      ;;
  esac
done

if [ "$should_run" = true ]; then
  echo "Running pre-push checks..."

  pull_rebase() {
    git fetch origin main 2>&1
    local behind ahead
    behind=$(git rev-list --count HEAD..origin/main)
    ahead=$(git rev-list --count origin/main..HEAD)

    if [ "$behind" -eq 0 ]; then
      echo "Already up to date with remote."
      return 0
    fi

    if [ "$ahead" -gt 0 ]; then
      echo "Branch has diverged (${ahead} ahead, ${behind} behind) â€” skipping auto-rebase."
      echo "If this is an intended force push, push will be rejected unless you use --force-with-lease."
      return 0
    fi

    echo "Integrating ${behind} new remote commit(s)..."
    if ! git rebase origin/main; then
      git rebase --abort 2>/dev/null || true
      echo ""
      echo "Rebase conflict: resolve the conflict below, then push again."
      return 1
    fi
  }

  type_check() {
    rm -rf "$ROOT_DIR/.next/dev"
    pnpm run typecheck
  }

  auto_changelog() {
    local before_sha after_sha
    before_sha=$(git rev-parse HEAD)
    node "${ROOT_DIR}/scripts/auto-changelog.mjs" || true
    after_sha=$(git rev-parse HEAD)
    if [ "$before_sha" != "$after_sha" ]; then
      local branch
      branch=$(git rev-parse --abbrev-ref HEAD)
      echo "Pre-push: pushing version bump..."
      git push --no-verify "$REMOTE" "$branch"
    fi
  }

  timed_step "git pull --rebase" pull_rebase
  timed_step "type check" type_check
  timed_step "auto-changelog" auto_changelog
  timed_step "build" pnpm run build

  print_timing_summary

  echo "Pre-push checks passed. Proceeding with push."
else
  echo "Pre-push: target branch is not main or pre-main. Skipping checks."
fi

exit 0
